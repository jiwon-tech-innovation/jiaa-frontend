name: Auto Add & Move Merged PR to Done

on:
  pull_request:
    types: [closed]

jobs:
  project-on-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Add PR to Project & Move to Done
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"

          # 1. Project ID
          PROJECT_ID=$(gh project view 1 \
            --owner "jiwon-tech-innovation" \
            --format json \
            --jq '.id')

          # 2. Status field ID
          FIELD_ID=$(gh project field-list 1 \
            --owner "jiwon-tech-innovation" \
            --format json \
            --jq '.fields[] | select(.name=="Status") | .id')

          # 3. Done option ID
          OPTION_ID=$(gh project field-list 1 \
            --owner "jiwon-tech-innovation" \
            --format json \
            --jq '.fields[] | select(.name=="Status") 
                  | .options[] | select(.name=="Done") | .id')

          # 4. PR이 이미 Project에 있는지 확인
          ITEM_ID=$(gh project item-list 1 \
            --owner "jiwon-tech-innovation" \
            --format json \
            --jq ".items[] 
                  | select(.content.url==\"$PR_URL\") 
                  | .id")

          # 5. 없으면 Project에 추가
          if [ -z "$ITEM_ID" ]; then
            ITEM_ID=$(gh project item-add 1 \
              --owner "jiwon-tech-innovation" \
              --url "$PR_URL" \
              --format json \
              --jq '.id')
          fi

          # 6. Status → Done
          gh project item-edit \
            --id "$ITEM_ID" \
            --project-id "$PROJECT_ID" \
            --field-id "$FIELD_ID" \
            --single-select-option-id "$OPTION_ID"

        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}