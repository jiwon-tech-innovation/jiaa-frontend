name: Auto Add & Move Merged PR (Supports Author & Fork)

on:
  pull_request_target:
    types: [opened, closed]
    branches:
      - 'main'
      - 'develop*'

jobs:
  project-automation:
    runs-on: ubuntu-latest
    steps:
      # 1. PR이 생성되었을 때 (Opened)
      - name: Add PR to Project & Set Author
        if: github.event.action == 'opened'
        id: add_pr
        uses: actions/add-to-project@v1.0.1
        with:
          project-url: https://github.com/orgs/jiwon-tech-innovation/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      - name: Set Status and Assignee
        if: github.event.action == 'opened'
        run: |
          # 프로젝트 및 필드 ID 가져오기
          PROJECT_ID=$(gh project view 1 --owner "jiwon-tech-innovation" --format json --jq '.id')
          FIELD_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq '.fields[] | select(.name=="Status") | .id')
          OPTION_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq ".fields[] | select(.name==\"Status\") | .options[] | select(.name==\"PR\") | .id")

          # 1. 상태를 'PR' 필드로 변경
          gh project item-edit --id ${{ steps.add_pr.outputs.itemId }} \
            --project-id "$PROJECT_ID" \
            --field-id "$FIELD_ID" \
            --single-select-option-id "$OPTION_ID"

          # 2. PR 작성자를 프로젝트 아이템의 담당자(Assignees)로 등록
          gh project item-edit --id ${{ steps.add_pr.outputs.itemId }} \
            --project-id "$PROJECT_ID" \
            --field "Assignees" --text "${{ github.event.pull_request.user.login }}"
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}

      # 2. PR이 머지되었을 때 (Closed & Merged)
      - name: Move to Done (Merged)
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          PR_URL="${{ github.event.pull_request.html_url }}"
          
          PROJECT_ID=$(gh project view 1 --owner "jiwon-tech-innovation" --format json --jq '.id')
          FIELD_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq '.fields[] | select(.name=="Status") | .id')
          OPTION_ID=$(gh project field-list 1 --owner "jiwon-tech-innovation" --format json --jq ".fields[] | select(.name==\"Status\") | .options[] | select(.name==\"Done\") | .id")
          
          ITEM_ID=$(gh project item-list 1 --owner "jiwon-tech-innovation" --format json --jq ".items[] | select(.content.url==\"$PR_URL\") | .id")
          
          if [ -n "$ITEM_ID" ]; then
            gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$FIELD_ID" --single-select-option-id "$OPTION_ID"
          fi
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
